{% extends 'base/layout.html' %}
{% load static %}

{% block title %}Terminal - {{ device }}{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.css" />
<style>
    /* 核心布局：固定 3/4 屏幕高度，居中显示 */
    #terminal-card-body {
        height: 75vh; /* 占据界面的 3/4 高度 */
        background-color: #000;
        display: flex;
        flex-direction: column;
        overflow: hidden !important;
        padding: 0 !important;
        border-radius: 0 0 4px 4px;
    }

    #terminal-container {
        flex-grow: 1;
        background-color: #000;
        padding: 0; /* 彻底移除所有内边距，确保 fit 计算 100% 准确 */
        margin: 0;
        overflow: hidden; 
        position: relative;
    }

    /* 移除所有干扰 xterm 渲染的样式 */
    .xterm {
        height: 100%;
        padding: 0;
    }

    /* 自定义滚动条样式，使其在深色背景下清晰可见 */
    .xterm .xterm-viewport::-webkit-scrollbar {
        width: 12px !important;
        display: block !important;
    }
    .xterm .xterm-viewport::-webkit-scrollbar-track {
        background: #000 !important;
        border-left: 1px solid #222;
    }
    .xterm .xterm-viewport::-webkit-scrollbar-thumb {
        background: #333 !important;
        border: 2px solid #000;
        border-radius: 6px;
    }
    .xterm .xterm-viewport::-webkit-scrollbar-thumb:hover {
        background: #555 !important;
    }

    /* 修正 NetBox 默认 card 样式，防止溢出 */
    .card {
        margin-bottom: 20px;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col col-12 col-lg-9"> <!-- 占据界面的 3/4 宽度 (col-9/12) -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>Terminal: {{ device }}</strong>
                    {% if device_ip %}
                    <span class="badge bg-info ms-2">{{ device_ip }}</span>
                    {% endif %}
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="location.reload();">
                        <i class="mdi mdi-refresh"></i> Reconnect
                    </button>
                </div>
            </div>
            <div id="terminal-card-body" class="card-body">
                <div id="debug-info" class="p-2 small text-muted bg-light border-bottom" style="display: none; color: #333 !important;">
                    <strong>Debug:</strong> <span id="debug-status">Initializing...</span>
                </div>
                <div id="terminal-container"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
{% if not error %}
<script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.js"></script>

<script>
    // 立即执行一次，确保 debug 能够显示
    (function() {
        console.log('Script loaded, waiting for DOM...');
    })();

    document.addEventListener('DOMContentLoaded', function() {
        const debugInfo = document.getElementById('debug-info');
        const debugStatus = document.getElementById('debug-status');
        
        function logDebug(msg, isError = false) {
            console.log('[Terminal Debug] ' + msg);
            if (debugInfo && debugStatus) {
                debugInfo.style.display = 'block';
                debugStatus.innerHTML = msg;
                if (isError) debugStatus.className = 'text-danger';
            }
        }

        try {
            logDebug('Initializing Terminal...');
            if (typeof Terminal === 'undefined') {
                throw new Error('xterm.js failed to load. Please check your internet connection or CDN availability.');
            }
            
            const term = new Terminal({
                cursorBlink: true,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                fontSize: 14,
                scrollback: 10000, // 允许向上滚动 10000 行
                theme: {
                    background: '#000000'
                }
            });
            
            logDebug('Terminal initialized.');
            
            if (typeof FitAddon === 'undefined') {
                logDebug('Warning: FitAddon not loaded, terminal may not resize correctly.');
            } else {
                const fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);
                window.fitAddon = fitAddon; // 挂载到全局方便调试
            }

            const container = document.getElementById('terminal-container');
            if (!container) {
                throw new Error('Terminal container element not found!');
            }
            
            term.open(container);
            logDebug('Terminal opened in container.');
            
            // 封装连接逻辑
            function connect() {
                const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                let wsUrl = protocol + window.location.host + '/ws/terminal/{{ device.pk }}/';
                
                const params = new URLSearchParams();
                const rawUser = '{{ ssh_username|escapejs }}';
                const rawPass = '{{ ssh_password|escapejs }}';
                
                if (rawUser) params.append('username', rawUser);
                if (rawPass) params.append('password', rawPass);
                
                // 确保发送的是 fit 之后的准确行列数
                params.append('rows', term.rows);
                params.append('cols', term.cols);
                
                const queryString = params.toString();
                if (queryString) wsUrl += '?' + queryString;

                logDebug('Connecting with size: ' + term.cols + 'x' + term.rows);
                const socket = new WebSocket(wsUrl);
                socket.binaryType = 'arraybuffer';

                socket.onopen = () => {
                    logDebug('WebSocket connection opened.');
                    term.write('\x1b[1;32m[Connected to NetBox Web SSH Bridge]\x1b[0m\r\n');
                };

                socket.onmessage = (event) => {
                    if (typeof event.data === 'string') {
                        try {
                            const data = JSON.parse(event.data);
                            if (data.message) term.write(data.message);
                        } catch (e) {
                            term.write(event.data);
                        }
                    } else {
                        const decoder = new TextDecoder('utf-8');
                        term.write(decoder.decode(event.data));
                    }
                };

                socket.onclose = (event) => {
                    logDebug('WebSocket closed (Code: ' + event.code + ').', true);
                    term.write('\r\n\x1b[1;31m[Connection closed]\x1b[0m\r\n');
                };

                socket.onerror = () => {
                    logDebug('WebSocket Error.', true);
                    term.write('\r\n\x1b[1;31m[WebSocket Error]\x1b[0m\r\n');
                };

                term.onData((data) => {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ data: data }));
                    }
                });

                term.onResize((size) => {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            resize: { cols: size.cols, rows: size.rows }
                        }));
                    }
                });

                window.addEventListener('resize', () => {
                    if (window.fitAddon) window.fitAddon.fit();
                });
            }

            // 流程控制：先计算尺寸，再启动连接
            if (document.fonts) {
                document.fonts.ready.then(() => {
                    setTimeout(() => {
                        if (window.fitAddon) window.fitAddon.fit();
                        connect();
                    }, 100); // 给 DOM 渲染留一点时间
                });
            } else {
                setTimeout(() => {
                    if (window.fitAddon) window.fitAddon.fit();
                    connect();
                }, 200);
            }

        } catch (err) {
            logDebug('Critical JS Error: ' + err.message, true);
            console.error(err);
        }
    });
</script>
{% endif %}
{% endblock %}
