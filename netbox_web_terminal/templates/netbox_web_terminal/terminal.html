{% extends 'base/layout.html' %}
{% load static %}

{% block title %}Terminal - {{ device }}{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.css" />
<style>
    /* 核心布局：固定 3/4 屏幕高度，居中显示 */
    #terminal-card-body {
        height: 75vh; /* 占据界面的 3/4 高度 */
        background-color: #000;
        display: flex;
        flex-direction: column;
        overflow: hidden !important;
        padding: 0 !important;
        border-radius: 0 0 4px 4px;
    }

    #terminal-container {
        flex-grow: 1;
        background-color: #000;
        padding: 10px; /* 在容器层设置内边距，不影响 xterm 内部计算 */
        margin: 0;
        overflow: hidden; 
        position: relative;
    }

    /* 移除对 xterm 内部结构的强制干预，让 xterm.js 自行管理 */
    .xterm {
        height: 100%;
    }

    /* 自定义滚动条样式，使其在深色背景下清晰可见 */
    .xterm .xterm-viewport::-webkit-scrollbar {
        width: 12px !important;
        display: block !important;
    }
    .xterm .xterm-viewport::-webkit-scrollbar-track {
        background: #000 !important;
        border-left: 1px solid #222;
    }
    .xterm .xterm-viewport::-webkit-scrollbar-thumb {
        background: #333 !important;
        border: 2px solid #000;
        border-radius: 6px;
    }
    .xterm .xterm-viewport::-webkit-scrollbar-thumb:hover {
        background: #555 !important;
    }

    /* 修正 NetBox 默认 card 样式，防止溢出 */
    .card {
        margin-bottom: 20px;
        overflow: hidden;
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col col-12 col-lg-9"> <!-- 占据界面的 3/4 宽度 (col-9/12) -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div>
                    <strong>Terminal: {{ device }}</strong>
                    {% if device_ip %}
                    <span class="badge bg-info ms-2">{{ device_ip }}</span>
                    {% endif %}
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-secondary" onclick="location.reload();">
                        <i class="mdi mdi-refresh"></i> Reconnect
                    </button>
                </div>
            </div>
            <div id="terminal-card-body" class="card-body">
                <div id="debug-info" class="p-2 small text-muted bg-light border-bottom" style="display: none; color: #333 !important;">
                    <strong>Debug:</strong> <span id="debug-status">Initializing...</span>
                </div>
                <div id="terminal-container"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
{% if not error %}
<script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.js"></script>

<script>
    // 立即执行一次，确保 debug 能够显示
    (function() {
        console.log('Script loaded, waiting for DOM...');
    })();

    document.addEventListener('DOMContentLoaded', function() {
        const debugInfo = document.getElementById('debug-info');
        const debugStatus = document.getElementById('debug-status');
        
        function logDebug(msg, isError = false) {
            console.log('[Terminal Debug] ' + msg);
            if (debugInfo && debugStatus) {
                debugInfo.style.display = 'block';
                debugStatus.innerHTML = msg;
                if (isError) debugStatus.className = 'text-danger';
            }
        }

        try {
            logDebug('Initializing Terminal...');
            if (typeof Terminal === 'undefined') {
                throw new Error('xterm.js failed to load. Please check your internet connection or CDN availability.');
            }
            
            const term = new Terminal({
                cursorBlink: true,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                fontSize: 14,
                scrollback: 10000, // 允许向上滚动 10000 行
                theme: {
                    background: '#000000'
                }
            });
            
            logDebug('Terminal initialized.');
            
            if (typeof FitAddon === 'undefined') {
                logDebug('Warning: FitAddon not loaded, terminal may not resize correctly.');
            } else {
                const fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);
                window.fitAddon = fitAddon; // 挂载到全局方便调试
            }

            const container = document.getElementById('terminal-container');
            if (!container) {
                throw new Error('Terminal container element not found!');
            }
            
            term.open(container);
            logDebug('Terminal opened in container.');
            
            // 确保字体加载后再进行 fit，否则列数计算会出错
            if (document.fonts) {
                document.fonts.ready.then(() => {
                    if (window.fitAddon) {
                        window.fitAddon.fit();
                        logDebug('Fonts loaded, terminal resized: ' + term.cols + 'x' + term.rows);
                    }
                });
            }

            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            let wsUrl = protocol + window.location.host + '/ws/terminal/{{ device.pk }}/';
            
            const params = new URLSearchParams();
            const rawUser = '{{ ssh_username|escapejs }}';
            const rawPass = '{{ ssh_password|escapejs }}';
            
            if (rawUser) params.append('username', rawUser);
            if (rawPass) params.append('password', rawPass);
            
            // 初始参数使用当前计算值
            params.append('rows', term.rows);
            params.append('cols', term.cols);
            
            const queryString = params.toString();
            if (queryString) {
                wsUrl += '?' + queryString;
            }

            logDebug('Connecting to WebSocket: ' + wsUrl);
            const socket = new WebSocket(wsUrl);
            socket.binaryType = 'arraybuffer'; // 使用二进制传输以获得更好的兼容性

            socket.onopen = () => {
                logDebug('WebSocket connection opened.');
                term.write('\x1b[1;32m[Connected to NetBox Web SSH Bridge]\x1b[0m\r\n');
                
                // 再次确保同步一次尺寸
                if (window.fitAddon) {
                    window.fitAddon.fit();
                    socket.send(JSON.stringify({
                        resize: {
                            rows: term.rows,
                            cols: term.cols
                        }
                    }));
                }
            };

            socket.onmessage = (event) => {
                if (typeof event.data === 'string') {
                    try {
                        const data = JSON.parse(event.data);
                        if (data.message) {
                            term.write(data.message);
                        }
                    } catch (e) {
                        term.write(event.data);
                    }
                } else {
                    // 处理二进制数据
                    const decoder = new TextDecoder('utf-8');
                    const text = decoder.decode(event.data);
                    term.write(text);
                }
            };

            socket.onclose = (event) => {
                logDebug('WebSocket connection closed (Code: ' + event.code + ').', true);
                term.write('\r\n\x1b[1;31m[Connection closed]\x1b[0m\r\n');
            };

            socket.onerror = (error) => {
                logDebug('WebSocket Error. Check Nginx proxy_set_header settings.', true);
                term.write('\r\n\x1b[1;31m[WebSocket Error]\x1b[0m\r\n');
            };

            term.onData((data) => {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({ data: data }));
                }
            });

            // 监听 xterm 内部的 resize 事件，这比监听 window 的 resize 更准确
            term.onResize((size) => {
                if (socket.readyState === WebSocket.OPEN) {
                    socket.send(JSON.stringify({
                        resize: {
                            cols: size.cols,
                            rows: size.rows
                        }
                    }));
                    logDebug('Terminal resized to: ' + size.cols + 'x' + size.rows);
                }
            });

            window.addEventListener('resize', () => {
                if (window.fitAddon) {
                    window.fitAddon.fit();
                }
            });

            // 延迟一会再次 fit，确保 DOM 渲染完成
            setTimeout(() => {
                if (window.fitAddon) {
                    window.fitAddon.fit();
                }
            }, 500);

        } catch (err) {
            logDebug('Critical JS Error: ' + err.message, true);
            console.error(err);
        }
    });
</script>
{% endif %}
{% endblock %}
