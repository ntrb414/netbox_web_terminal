{% extends 'base/layout.html' %}
{% load static %}

{% block title %}Terminal - {{ device }}{% endblock %}

{% block extra_styles %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.1.0/css/xterm.css" />
<style>
    /* 核心布局优化 */
    #terminal-card-body {
        height: 75vh;
        background-color: #000;
        display: flex;
        flex-direction: column;
        overflow: hidden; 
        padding: 0 !important;
        border-radius: 0 0 4px 4px;
    }

    /* 调试信息栏 - 紧凑型设计 */
    #debug-info {
        background-color: #222;
        color: #aaa !important;
        font-size: 11px;
        padding: 2px 10px;
        border-bottom: 1px solid #333;
        flex-shrink: 0;
    }

    #terminal-container {
        flex: 1;
        width: 100%;
        background-color: #000;
        margin: 0;
        padding: 0;
        overflow: hidden;
        position: relative;
    }

    /* 强制填满容器 */
    .xterm {
        position: absolute !important;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        padding: 4px;
    }

    .xterm .xterm-viewport {
        overflow-y: auto !important;
        background-color: #000 !important;
    }

    /* 滚动条美化 */
    .xterm .xterm-viewport::-webkit-scrollbar {
        width: 8px;
    }
    .xterm .xterm-viewport::-webkit-scrollbar-track {
        background: #000;
    }
    .xterm .xterm-viewport::-webkit-scrollbar-thumb {
        background: #333;
        border-radius: 4px;
    }
    .xterm .xterm-viewport::-webkit-scrollbar-thumb:hover {
        background: #444;
    }

    .card {
        margin-bottom: 20px;
        border: none;
        box-shadow: 0 4px 20px rgba(0,0,0,0.15);
    }
</style>
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col col-12 col-lg-11">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
                <div>
                    <i class="mdi mdi-console"></i>
                    <strong class="ms-2">{{ device }}</strong>
                    {% if device_ip %}
                    <small class="text-muted ms-2">({{ device_ip }})</small>
                    {% endif %}
                </div>
                <button class="btn btn-sm btn-outline-light" onclick="location.reload();">
                    <i class="mdi mdi-refresh"></i> Reconnect
                </button>
            </div>
            <div id="terminal-card-body" class="card-body">
                <div id="debug-info" style="display: none;">
                    <strong>Status:</strong> <span id="debug-status text-info">Connecting...</span>
                </div>
                <div id="terminal-container"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
{% if not error %}
<script src="https://cdn.jsdelivr.net/npm/xterm@5.1.0/lib/xterm.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.7.0/lib/xterm-addon-fit.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const debugInfo = document.getElementById('debug-info');
        const debugStatus = document.getElementById('debug-status');
        
        function logDebug(msg, isError = false) {
            console.log('[SSH] ' + msg);
            if (debugInfo && debugStatus) {
                debugInfo.style.display = 'block';
                debugStatus.textContent = msg;
                debugStatus.className = isError ? 'text-danger' : 'text-info';
            }
        }

        async function initTerminal() {
            try {
                const term = new Terminal({
                    cursorBlink: true,
                    fontFamily: 'Consolas, "Liberation Mono", Menlo, Courier, monospace',
                    fontSize: 14,
                    scrollback: 5000,
                    convertEol: true,
                    theme: {
                        background: '#000000',
                        foreground: '#ffffff',
                        cursor: '#ffffff'
                    },
                    allowProposedApi: true
                });
                
                const fitAddon = new FitAddon.FitAddon();
                term.loadAddon(fitAddon);

                const container = document.getElementById('terminal-container');
                term.open(container);
                
                // 解决渲染延迟导致的尺寸计算偏差
                if (document.fonts) {
                    await document.fonts.ready;
                }

                // 初始适应尺寸
                const performFit = () => {
                    try {
                        fitAddon.fit();
                        console.log(`Resized to: ${term.cols}x${term.rows}`);
                    } catch (e) {
                        console.warn('Fit failed:', e);
                    }
                };

                performFit();

                // 使用 ResizeObserver 监听容器变化，这是最可靠的自适应方式
                const resizeObserver = new ResizeObserver(() => {
                    performFit();
                    if (socket && socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({
                            resize: { cols: term.cols, rows: term.rows }
                        }));
                    }
                });
                resizeObserver.observe(container);

                const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
                let wsUrl = protocol + window.location.host + '/ws/terminal/{{ device.pk }}/';
                
                const params = new URLSearchParams();
                const rawUser = '{{ ssh_username|escapejs }}';
                const rawPass = '{{ ssh_password|escapejs }}';
                if (rawUser) params.append('username', rawUser);
                if (rawPass) params.append('password', rawPass);
                
                // 传初始尺寸
                params.append('rows', term.rows);
                params.append('cols', term.cols);
                
                const queryString = params.toString();
                if (queryString) wsUrl += '?' + queryString;

                const socket = new WebSocket(wsUrl);
                socket.binaryType = 'arraybuffer';

                socket.onopen = () => {
                    logDebug('Connected');
                    term.focus();
                    // 连接瞬间再次确认尺寸
                    performFit();
                    socket.send(JSON.stringify({
                        resize: { rows: term.rows, cols: term.cols }
                    }));
                };

                socket.onmessage = async (event) => {
                    let text = '';
                    if (typeof event.data === 'string') {
                        try {
                            const data = JSON.parse(event.data);
                            text = data.message || event.data;
                        } catch (e) {
                            text = event.data;
                        }
                    } else {
                        const buffer = event.data instanceof ArrayBuffer ? event.data : await event.data.arrayBuffer();
                        text = new TextDecoder('utf-8').decode(buffer);
                    }
                    
                    term.write(text);
                    
                    // 只有当输出导致内容增加时才尝试滚动
                    if (term.buffer.active.baseY > 0) {
                        term.scrollToBottom();
                    }
                };

                socket.onclose = () => {
                    logDebug('Disconnected', true);
                    term.write('\r\n\x1b[1;31m[Connection Closed]\x1b[0m\r\n');
                    resizeObserver.disconnect();
                };

                socket.onerror = () => {
                    logDebug('Network Error', true);
                    term.write('\r\n\x1b[1;31m[Connection Error]\x1b[0m\r\n');
                };

                term.onData((data) => {
                    if (socket.readyState === WebSocket.OPEN) {
                        socket.send(JSON.stringify({ data: data }));
                    }
                });

                // 清理函数
                window.addEventListener('beforeunload', () => {
                    if (socket) socket.close();
                    resizeObserver.disconnect();
                });

            } catch (err) {
                logDebug('System Error: ' + err.message, true);
            }
        }

        initTerminal();
    });
</script>
{% endif %}
{% endblock %}
